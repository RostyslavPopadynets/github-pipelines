name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["CI - Lint, Test, Build & SonarCloud"]  # must match CI workflow name exactly
    types: [completed]

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read   # allow reading artifacts from other runs

concurrency:
  group: "pages"
  cancel-in-progress: false


jobs:
  probe:
    # Always run when the workflow is triggered (no job-level "if")
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.check.outputs.ok }}
      conclusion: ${{ steps.check.outputs.conclusion }}
      head_branch: ${{ steps.check.outputs.head_branch }}
      event: ${{ steps.check.outputs.event }}
    steps:
      - name: Show raw workflow_run payload
        run: |
          echo '--- github.event.workflow_run (JSON) ---'
          echo '${{ toJSON(github.event.workflow_run) }}'
          echo '--- end ---'

      - id: check
        shell: bash
        run: |
          conclusion='${{ github.event.workflow_run.conclusion }}'
          head_branch='${{ github.event.workflow_run.head_branch }}'
          event='${{ github.event.workflow_run.event }}'

          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "head_branch=$head_branch" >> "$GITHUB_OUTPUT"
          echo "event=$event" >> "$GITHUB_OUTPUT"

          # Decide if we should deploy
          if [[ "$conclusion" == "success" && "$head_branch" == "main" ]]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize decision
        run: |
          echo "Conclusion: ${{ steps.check.outputs.conclusion }}"
          echo "Head branch: ${{ steps.check.outputs.head_branch }}"
          echo "Event: ${{ steps.check.outputs.event }}"
          echo "Should deploy? ${{ steps.check.outputs.ok }}"

  deploy:
    needs: probe
    if: needs.probe.outputs.ok == 'true'   # gate here
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Download dist from CI run
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: dist
          path: dist
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
